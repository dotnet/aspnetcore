<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PhotinoTestApp</title>
    <base href="/subdir/" />
    <link href="css/app.css" rel="stylesheet" />
</head>

<body>
    <root>Loading...</root>

    <!-- Explicit display:none required so StartupErrorNotificationTest can observe it change -->
    <div id="blazor-error-ui" style="display: none;">
        An unhandled error has occurred.
        <a href class='reload'>Reload</a>
        <a class='dismiss' style="cursor: pointer;">ðŸ—™</a>
    </div>

    <script src="_framework/blazor.webview.js"></script>

    <script>
        // These methods are used to communicate with the test infrastructure. The test can
        // send messages to this JS code to invoke things or to check the status of things.

        function PostMessageToDotNet(message) {
            if (window.chrome && window.chrome.webview) {
                // Windows WebView2
                window.chrome.webview.postMessage(message);
            }
            else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.webwindowinterop) {
                // iOS and MacCatalyst WKWebView
                window.webkit.messageHandlers.webwindowinterop.postMessage(message);
            }
            else {
                // Android WebView
                // TODO: Not yet supported
            }
        }

        // Wait for Blazor to be fully ready
        function waitForBlazorAndSignal() {
            function checkBlazorReady() {
                // Check if Blazor has finished loading by looking for the root content
                var root = document.querySelector('root');
                var controlDiv = document.getElementById('controlDiv');

                // Send diagnostic information about what we found
                var rootText = root ? root.innerText : 'ROOT_NOT_FOUND';
                var controlDivExists = controlDiv ? 'EXISTS' : 'NOT_FOUND';
                PostMessageToDotNet('wvt:ConsoleLog:Blazor readiness check: root=' + rootText + ', controlDiv=' + controlDivExists);

                // Blazor is ready when:
                // 1. The root element no longer shows "Loading..."
                // 2. The controlDiv element exists (indicating the component has rendered)
                if (root && root.innerText !== 'Loading...' && controlDiv) {
                    PostMessageToDotNet('wvt:ConsoleLog:Blazor is ready! Sending wvt:Started');
                    PostMessageToDotNet('wvt:Started');
                    return true;
                }
                return false;
            }

            // Try immediately
            if (checkBlazorReady()) {
                return;
            }

            PostMessageToDotNet('wvt:ConsoleLog:Starting Blazor readiness polling (100ms intervals, max 10 seconds)');

            // Poll every 100ms for up to 10 seconds
            var attempts = 0;
            var maxAttempts = 100; // 10 seconds
            var interval = setInterval(function() {
                attempts++;
                if (checkBlazorReady() || attempts >= maxAttempts) {
                    clearInterval(interval);
                    if (attempts >= maxAttempts) {
                        // Fallback - signal anyway after timeout
                        PostMessageToDotNet('wvt:ConsoleLog:Blazor initialization timeout: Giving up after ' + attempts + ' attempts');
                        PostMessageToDotNet('wvt:Started');
                    }
                }
            }, 100);
        }

        function initializeWebViewTest() {
            window.chrome.webview.addEventListener('message', event => {
                console.log("ALL: Received message: " + event.data);
                if (!event.data.startsWith('__bwv')) {
                    console.log("FILTER: Received message: " + event.data);

                    if (event.data === "wvt:GetControlDivValue") {
                        var controlDiv = document.getElementById('controlDiv');
                        var controlDivValue = controlDiv ? controlDiv.innerText : 'ELEMENT_NOT_FOUND';
                        PostMessageToDotNet('wvt:NewControlDivValue:' + controlDivValue);
                    }
                    else if (event.data.startsWith("wvt:ClickButton:")) {
                        var buttonToClick = event.data.substring(16);
                        var button = document.getElementById(buttonToClick);
                        if (button) {
                            button.click();
                        }
                    }
                }
            });

            // Start waiting for Blazor
            waitForBlazorAndSignal();
        }

        // Try to initialize immediately (in case DOMContentLoaded already fired)
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
            document.addEventListener('DOMContentLoaded', initializeWebViewTest);
        } else {
            // DOM is already loaded (DOMContentLoaded already fired or we're in complete state)
            initializeWebViewTest();
        }

        // Additional safety net - initialize after a short delay regardless
        setTimeout(function() {
            if (!window.webViewTestInitialized) {
                window.webViewTestInitialized = true;
                initializeWebViewTest();
            }
        }, 100);

    </script>
</body>

</html>
