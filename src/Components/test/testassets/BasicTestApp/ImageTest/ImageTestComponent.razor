@using System.IO
@using Microsoft.AspNetCore.Components.Web.Image

@implements IAsyncDisposable

<h3>Image Component Tests</h3>

<div>
    <h4>Test Controls</h4>
    <button id="load-png" @onclick="LoadPngWithCache">Load PNG</button>
    <button id="load-jpg-stream" @onclick="LoadJpgFromStream">Load JPG (Stream)</button>
    <button id="load-small-chunks" @onclick="LoadImageSmallChunks">Load Large Image (Small Chunks)</button>
    <button id="change-source" @onclick="ChangeDynamicImageSource">Change Dynamic Source</button>

    <div id="test-status">
        Status: <span id="current-status">@_currentStatus</span>
    </div>
</div>

@if (_pngBasic)
{
    <div>
        <h4>PNG basic</h4>
        <div id="png-basic-container">
            <Image @ref="@_pngBasicRef"
                   Source="@_basicImageSource" />
        </div>
    </div>
}

@if (_jpgStream)
{
    <div>
        <h4>JPG Stream</h4>
        <div id="jpg-stream-container">
            <Image @ref="@_jpgStreamRef"
                   Source="@_jpgStreamSource" />
        </div>
    </div>
}

@if (_smallChunks)
{
    <div>
        <h4>Small chunks Image</h4>
        <div id="chunked-image-container">
            <Image @ref="@_smallChunksRef"
                   Source="@_smallChunksSource"
                   ChunkSize="@_chunkSize" />
        </div>
    </div>
}

@if (_dynamicSource)
{
    <div>
        <h4>Dynamic Source Image</h4>
        <div id="dynamic-source-container">
            <Image @ref="@_dynamicSourceRef"
                   Source="@_dynamicImageSource" />
        </div>
    </div>
}

@code {
    private Image _pngBasicRef;
    private Image _jpgStreamRef;
    private Image _smallChunksRef;
    private Image _dynamicSourceRef;

    private ImageSource _basicImageSource = new ImageSource(new byte[0], "");
    private ImageSource _jpgStreamSource = new ImageSource(new byte[0], "");
    private ImageSource _smallChunksSource = new ImageSource(new byte[0], "");
    private ImageSource _dynamicImageSource = new ImageSource(new byte[0], "");

    private bool _pngBasic = false;
    private bool _jpgStream = false;
    private bool _smallChunks = false;
    private bool _dynamicSource = false;

    private string _currentStatus = "Ready";
    private int _chunkSize = 128; // Small chunks for testing
    private bool _isCurrentlyShowingPng = true; // Track which image is currently shown in dynamic test

    // Test image data - 1x1 gray PNG and JPG byte arrays
    private static readonly byte[] TestPngData = Convert.FromBase64String("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjqK6u/g8ABVcCcYoGhmwAAAAASUVORK5CYII=");

    private static readonly byte[] TestJpgData = Convert.FromBase64String("/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/wAALCAABAAEBAREA/8QAFAABAAAAAAAAAAAAAAAAAAAAAP/EABQQAQAAAAAAAAAAAAAAAAAAAAD/2gAIAQEAAD8AN//Z");

    protected override void OnInitialized()
    {
        _currentStatus = "Component initialized";
    }

    private async Task LoadPngWithCache()
    {
        _currentStatus = "Loading PNG with cache...";
        _basicImageSource = new ImageSource(TestPngData, "image/png", "test-png-cached");
        _pngBasic = true;
        await Task.Delay(10);
        _currentStatus = "PNG basic loaded";
    }

    private async Task LoadJpgFromStream()
    {
        _currentStatus = "Loading JPG from stream...";
        var stream = new MemoryStream(TestJpgData);
        _jpgStreamSource = new ImageSource(stream, "image/jpeg", "test-jpg-stream");
        await Task.Delay(10);
        _jpgStream = true;
        _currentStatus = "JPG from stream loaded";

    }

    private async Task LoadImageSmallChunks()
    {
        _currentStatus = "Loading large image with small chunks...";
        _smallChunksSource = new ImageSource(TestJpgData, "image/jpg", "large-chunked-image");
        await Task.Delay(10);
        _smallChunks = true;
        _currentStatus = "Small chunks image loaded";
    }

    private async Task ChangeDynamicImageSource()
    {
        if (!_dynamicSource)
        {
            // First time - show the component with PNG
            _currentStatus = "Loading dynamic source (PNG)...";
            _dynamicImageSource = new ImageSource(TestPngData, "image/png", "dynamic-png");
            _dynamicSource = true;
            _isCurrentlyShowingPng = true;
            await Task.Delay(10);
            _currentStatus = "Dynamic source initialized with PNG";
        }
        else
        {
            // Toggle between PNG and JPG
            if (_isCurrentlyShowingPng)
            {
                _currentStatus = "Changing to JPG...";
                _dynamicImageSource = new ImageSource(TestJpgData, "image/jpeg", "dynamic-jpg");
                _isCurrentlyShowingPng = false;
                await Task.Delay(10);
                _currentStatus = "Dynamic source changed to JPG";
            }
            else
            {
                _currentStatus = "Changing to PNG...";
                _dynamicImageSource = new ImageSource(TestPngData, "image/png", "dynamic-png");
                _isCurrentlyShowingPng = true;
                await Task.Delay(10);
                _currentStatus = "Dynamic source changed to PNG";
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        _currentStatus = "Disposing component...";

        if (_dynamicSourceRef != null)
            await _dynamicSourceRef.DisposeAsync();
        if (_smallChunksRef != null)
            await _smallChunksRef.DisposeAsync();
        if (_jpgStreamRef != null)
            await _jpgStreamRef.DisposeAsync();
        if (_pngBasicRef != null)
            await _pngBasicRef.DisposeAsync();
    }
}
