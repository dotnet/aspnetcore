<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="_ResolveInputArguments">
    <PropertyGroup>
      <_MvcRazorOutputPath Condition="'$(MvcRazorOutputPath)'!=''">$([MSBuild]::EnsureTrailingSlash('$(MvcRazorOutputPath)'))</_MvcRazorOutputPath>
      <_MvcRazorOutputPath Condition="'$(_MvcRazorOutputPath)'==''">$(IntermediateOutputPath)</_MvcRazorOutputPath>
      <_MvcRazorOutputFullPath>$(_MvcRazorOutputPath)$(MSBuildProjectName).PrecompiledViews.dll</_MvcRazorOutputFullPath>
      <_MvcRazorResponseFilePath>$(IntermediateOutputPath)microsoft.aspnetcore.mvc.razor.viewcompilation.rsp</_MvcRazorResponseFilePath>

      <MvcRazorContentRoot Condition="'$(MvcRazorContentRoot)'==''">$(MSBuildProjectDirectory)</MvcRazorContentRoot>
      <MvcRazorExcludeViewFilesFromPublish Condition="'$(MvcRazorExcludeViewFilesFromPublish)'==''">true</MvcRazorExcludeViewFilesFromPublish>
      <MvcRazorExcludeRefAssembliesFromPublish Condition="'$(MvcRazorExcludeRefAssembliesFromPublish)'==''">true</MvcRazorExcludeRefAssembliesFromPublish>
    </PropertyGroup>

    <ItemGroup Condition="'@(MvcRazorFilesToCompile)' == ''">
      <MvcRazorFilesToCompile Include="@(Content)" Condition="'%(Extension)'=='.cshtml'" />
    </ItemGroup>
  </Target>

  <Target Name="_CreateResponseFileForMvcRazorPrecompile">
    <ItemGroup>
      <ExecArgs Include="
        $(MSBuildProjectDirectory);
        --output-path=$(_MvcRazorOutputPath);
        --application-name=$(MSBuildProjectName);
        --content-root=$(MvcRazorContentRoot);" />

      <ExecArgs
        Condition="'$(MvcRazorEmbedViewSources)'=='true'"
        Include="--embed-view-sources" />

      <ExecArgs Include="--file=%(MvcRazorFilesToCompile.FullPath)" />
    </ItemGroup>

    <ItemGroup Condition="'$(SignAssembly)'=='true'">
      <ExecArgs
        Condition="'$(DelaySign)'=='true'"
        Include="--delay-sign" />
      <ExecArgs
        Condition="'$(PublicSign)'=='true'"
        Include="--public-sign" />
      <ExecArgs Include="--key-file=$(AssemblyOriginatorKeyFile)" />
    </ItemGroup>

    <WriteLinesToFile
      File="$(_MvcRazorResponseFilePath)"
      Lines="@(ExecArgs)"
      Overwrite="true"  />
  </Target>

  <Target
     Name="_MvcRazorPrecompileOnPublish"
     DependsOnTargets="MvcRazorPrecompile"
     AfterTargets="PrepareForPublish"
     Condition="'$(MvcRazorCompileOnPublish)'=='true'" />

  <Target Name="_MvcRazorResolveFilesToCompute"
    AfterTargets="ComputeRefAssembliesToPublish"
    Condition="'$(MvcRazorCompileOnPublish)'=='true'">

    <ItemGroup>
      <ResolvedFileToPublish
          Remove="%(MvcRazorFilesToCompile.FullPath)"
          Condition="'$(MvcRazorExcludeViewFilesFromPublish)'=='true'" />

      <ResolvedFileToPublish Include="$(_MvcRazorOutputFullPath)" CopyToPublishDirectory="Always">
        <RelativePath>$([System.IO.Path]::GetFileName('$(_MvcRazorOutputFullPath)'))</RelativePath>
      </ResolvedFileToPublish>
    </ItemGroup>

    <ItemGroup Condition="'$(MvcRazorExcludeRefAssembliesFromPublish)'=='true'">
      <ResolvedFileToPublish
        Remove="%(ResolvedFileToPublish.Identity)"
        Condition="'%(ResolvedFileToPublish.RelativePath)'=='$(RefAssembliesFolderName)\%(Filename)%(Extension)'" />
    </ItemGroup>
  </Target>
</Project>

