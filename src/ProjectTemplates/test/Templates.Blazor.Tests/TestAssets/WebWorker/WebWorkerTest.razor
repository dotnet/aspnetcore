@* Licensed to the .NET Foundation under one or more agreements. *@
@* The .NET Foundation licenses this file to you under the MIT license. *@

@page "/webworker-test"

@using WorkerLib
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>WebWorker Test</PageTitle>

<div id="webworker-test">
    <h3>WebWorker E2E Test</h3>

    <div>
        <button id="btn-init" @onclick="InitWorker">Initialize Worker</button>
        <span id="init-status">@InitStatus</span>
    </div>

    <div>
        <button id="btn-dispose" @onclick="DisposeWorker" disabled="@(!IsReady)">Dispose Worker</button>
        <span id="dispose-status">@DisposeStatus</span>
    </div>
</div>

@code {
    private WebWorkerClient? Worker;
    private string InitStatus = "Not initialized";
    private string DisposeStatus = "";

    private bool IsReady => Worker != null && DisposeStatus != "Disposed";

    private async Task InitWorker()
    {
        try
        {
            InitStatus = "Initializing...";
            StateHasChanged();
            await Task.Yield();

            Worker = await WebWorkerClient.CreateAsync(JSRuntime);
            InitStatus = "Ready";
        }
        catch (Exception ex)
        {
            InitStatus = $"Error: {ex.Message}";
            Console.WriteLine($"[WebWorkerTest] Init error: {ex}");
        }
    }

    private async Task DisposeWorker()
    {
        if (Worker != null)
        {
            await Worker.DisposeAsync();
            Worker = null;
            DisposeStatus = "Disposed";
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (Worker != null)
        {
            await Worker.DisposeAsync();
        }
    }
}
