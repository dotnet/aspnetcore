@* ============================================================================
   SAMPLE CODE - This page demonstrates WebWorker usage patterns.
   Feel free to delete this file and create your own pages.
   ============================================================================ *@
@page "/webworker-demo"
@*#if (UseRenderMode)
@rendermode InteractiveWebAssembly
#endif*@
@namespace WebWorkerTemplate.Pages
@using WebWorkerTemplate.Models

<PageTitle>WebWorker Demo - GitHub Analytics</PageTitle>

<h1>🐙 GitHub Analytics</h1>
<p class="lead">Fetch live data from GitHub API and process it in a WebWorker.</p>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Repository</h5>
                <div class="input-group mb-3">
                    <span class="input-group-text">github.com/</span>
                    <input type="text" class="form-control" @bind="_repository" placeholder="dotnet/aspnetcore" />
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Pages to fetch (100 items/page)</label>
                    <input type="number" class="form-control" @bind="_maxPages" min="1" max="10" />
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning h-100">
            <div class="card-body">
                <h5 class="card-title">UI Responsiveness Test</h5>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-warning btn-lg" @onclick="IncrementCounter">
                        👆 Click!
                    </button>
                    <span class="display-5">@_clickCount</span>
                </div>
                <p class="text-muted small mt-2 mb-0">Try clicking during fetch to verify the UI stays responsive.</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <button class="btn btn-primary btn-lg mb-2" @onclick="() => FetchAsync(true)" disabled="@_isProcessing">
                    @if (_isProcessing && _processingMode == "worker")
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Fetching...</span>
                    }
                    else
                    {
                        <span>⚡ Fetch with WebWorker</span>
                    }
                </button>
                <button class="btn btn-outline-danger" @onclick="() => FetchAsync(false)" disabled="@_isProcessing">
                    @if (_isProcessing && _processingMode == "ui")
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Fetching...</span>
                    }
                    else
                    {
                        <span>🔥 Fetch on UI Thread</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger alert-dismissible">
        @_errorMessage
        <button type="button" class="btn-close" @onclick="() => _errorMessage = string.Empty"></button>
    </div>
}

<div class="row mb-4">
    @foreach (var (metrics, title, color) in new[] {
        (_metricsWorker, "⚡ WebWorker Result", "primary"),
        (_metricsUI, "🔥 UI Thread Result", "danger")
    }.Where(x => x.Item1 != null))
    {
        <div class="col-md-6">
            <div class="card border-@color h-100">
                <div class="card-header bg-@color text-white">@title</div>
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="https://github.com/@metrics!.Repository" target="_blank">@metrics!.Repository</a>
                    </h5>
                    <div class="row mb-3">
                        <div class="col-6"><strong>Total Items:</strong> @metrics!.TotalItems</div>
                        <div class="col-6"><strong>Open:</strong> @metrics!.OpenItems / <strong>Closed:</strong> @metrics!.ClosedItems</div>
                    </div>
                    <div class="row">
                        <div class="col-4"><strong>Fetch:</strong> @metrics!.FetchTimeMs.ToString("F0") ms</div>
                        <div class="col-4"><strong>Deserialize:</strong> @metrics!.DeserializationTimeMs.ToString("F0") ms</div>
                        <div class="col-4"><strong>Compute:</strong> @metrics!.ComputationTimeMs.ToString("F2") ms</div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@{
    var displayMetrics = _metricsWorker ?? _metricsUI;
}
@if (displayMetrics != null)
{

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card h-100">
                <div class="card-header">Top Labels</div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <tbody>
                            @foreach (var label in displayMetrics.TopLabels)
                            {
                                <tr>
                                    <td><code>@label.Label</code></td>
                                    <td class="text-end">@label.Count</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}
