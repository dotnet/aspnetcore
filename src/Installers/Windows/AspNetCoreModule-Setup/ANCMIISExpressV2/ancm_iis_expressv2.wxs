<!--
    AspNetCoreModule setup. v1 for initial release.
-->

<?define Codepage = "1252" ?>
<?include ..\IIS-Setup\include.wxi ?>

<?define ProductCode = "*" ?>
<?if $(InstallerPlatform)=x64?>
  <?define ANCMUpgradeCode = "da062c0f-12c2-4703-8ed7-0cad342a53a1" ?>
<?else?>
  <?define ANCMUpgradeCode = "de400ae0-3cd7-4a35-a234-b5a41b90893c" ?>
<?endif?>

<?define ProductShortName="IIS Express AspNetCore Module V2" ?>
<?define ProductNameShort="IISExpress_ANCM_V2" ?>
<?define ProductVersionString = "V2"?>
<?define ProductName="Asp.Net Core Module"?>

<?if $(PlatformValue)="Intel" ?>
  <?undef PlatformValue ?>
  <?define PlatformValue = "x86" ?>
<?endif?>

<?define AspNetCoreSectionName = "aspNetCore" ?>
<?define AspNetCoreTraceProviderName = "ANCM" ?>
<?define AspNetCoreTraceProviderValue = "65536" ?>
<?define AspNetCoreModuleName = "AspNetCoreModuleV2" ?>

<?if $(InstallerPlatform) = "x86" ?>
    <?define SchemaGuid = "e629b31a-3d56-4b5c-959c-586fc1c55599" ?>
    <?define AspNetCoreV2ProgramFilesTargetPath = "$(ArtifactsDir)\bin\AspNetCoreModuleShim\Win32\$(Configuration)\aspnetcorev2.dll" ?>
    <?define AspNetCoreV2HandlerProgramFilesTargetPath = "$(ArtifactsDir)\bin\OutOfProcessRequestHandler\Win32\$(Configuration)\aspnetcorev2_outofprocess.dll" ?>
<?else?>
    <?define SchemaGuid = "ab582af2-d6c0-43f7-8412-76a19c65d7f2" ?>
    <?define SchemaGuid32 = "e629b31a-3d56-4b5c-959c-586fc1c55599" ?>
    <?define AspNetCoreV2ProgramFilesTargetPath = "$(ArtifactsDir)\bin\AspNetCoreModuleShim\$(InstallerPlatform)\$(Configuration)\aspnetcorev2.dll" ?>
    <?define AspNetCoreV2HandlerProgramFilesTargetPath = "$(ArtifactsDir)\bin\OutOfProcessRequestHandler\$(InstallerPlatform)\$(Configuration)\aspnetcorev2_outofprocess.dll" ?>
<?endif?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:dep="http://wixtoolset.org/schemas/v4/wxs/dependency" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <Package Name="!(loc.AspNetCoreIISExpressModuleProductNameV2)" Manufacturer="!(loc.Manufacturer)" Version="$(ANCMMsiVersion)" Language="!(loc.Language)" Codepage="$(Codepage)" UpgradeCode="$(ANCMUpgradeCode)" InstallerVersion="$(ANCMInstallerVersion)" ProductCode="$(ProductCode)" Scope="perMachine">
        <SummaryInformation Description="!(loc.AspNetCoreIISExpressModuleProductNameV2)" Manufacturer="!(loc.Manufacturer)" />

        <Media Id="1" Cabinet="aspnetcoremodule.cab" EmbedCab="yes" CompressionLevel="high" />

        <Property Id="ARPCONTACT" Value="Microsoft Corporation" />
        <Property Id="ARPPRODUCTICON" Value="AspNetCoreModule.ico" />
        <Icon Id="AspNetCoreModule.ico" SourceFile="..\Bitmaps\AspNetCoreModule.ico" />

        <WixVariable Id="WixUILicenseRtf" Value="..\license\license.rtf" />

        <Upgrade Id="$(ANCMUpgradeCode)">
            <UpgradeVersion OnlyDetect="no" Property="OLDERVERSIONFOUND" Maximum="$(ANCMMsiVersion)" IncludeMaximum="no" MigrateFeatures="yes" />
            <UpgradeVersion OnlyDetect="yes" Property="NEWERVERSIONFOUND" Minimum="$(ANCMMsiVersion)" IncludeMinimum="no" />
        </Upgrade>

        <Launch Condition="(NOT NEWERVERSIONFOUND) OR Installed" Message="!(loc.NewerVersionFound)" />

        <!-- Require the user be an admin to install -->
        <Launch Condition="Privileged" Message="!(loc.AdminRequired)" />

        <Property Id="IISEXPRESS_INSTALL" Secure="yes">
            <RegistrySearch Id="IISExpressInstallRegSearch" Root="HKLM" Key="SOFTWARE\Microsoft\IISExpress" Name="Version" Type="raw" Bitness="$(Bitness)" />
        </Property>

        <Property Id="IISEXPRESS_INSTALL_PATH" Secure="yes">
            <DirectorySearch Id="ProgramFilesSearch" Path="[$(ProgramFilesFolder)]">
               <DirectorySearch Id="IISExpressInstallPathSearch" Path="IIS Express" AssignToProperty="yes">
                   <FileSearch Id="IISExpressExe" Name="iisexpress.exe" />
               </DirectorySearch>
            </DirectorySearch>
        </Property>

        <Property Id="IISEXPRESS_APPHOST_CONFIG" Secure="yes">
            <DirectorySearchRef Id="ProgramFilesSearch" Path="[$(ProgramFilesFolder)]">
               <DirectorySearch Id="IISExpressAppServerPathSearch" Path="IIS Express\AppServer">
                  <FileSearch Id="AppHostConfig" Name="applicationhost.config" />
               </DirectorySearch>
            </DirectorySearchRef>
        </Property>

        <Property Id="IISEXPRESS_APPHOST_CONFIG_TMP" Secure="yes">
            <DirectorySearchRef Id="ProgramFilesSearch" Path="[$(ProgramFilesFolder)]">
               <DirectorySearch Id="IISExpressTmpPathSearch" Path="IIS Express\config\templates\PersonalWebServer">
                  <FileSearch Id="AppHostConfigTmp" Name="applicationhost.config" />
               </DirectorySearch>
            </DirectorySearchRef>
        </Property>

        <Launch Condition="Installed Or IISEXPRESS_INSTALL_PATH" Message="!(loc.AspNetCoreModuleIISExpressPrereq)" />
        <?if $(InstallerPlatform) != "x86" ?>
          <Launch Condition="Installed Or IISEXPRESS_INSTALL_PATH32" Message="!(loc.AspNetCoreModuleIISExpressPrereq)" />
        <?endif?>

        <!-- prevent install of 32 bit product on 64 bit machine -->
        <?if "x86" = "$(InstallerPlatform)" ?>
        <Launch Condition="Installed Or NOT VersionNT64" Message="!(loc.LaunchCondition_64BIT)" />
        <?endif?>

        <!-- also prevent install of 64-bit product on 32-bit machine -->
        <?if $(InstallerPlatform) != "x86"?>
        <Launch Condition="(Installed And NOT PATCH) Or VersionNT64" Message="!(loc.LaunchCondition_32BIT)" />
        <?endif?>

        <?if $(InstallerPlatform) != "x86" ?>
            <Property Id="IISEXPRESS_INSTALL_PATH32" Secure="yes">
                <DirectorySearch Id="ProgramFilesSearch32" Path="[ProgramFilesFolder]">
                   <DirectorySearch Id="IISExpressInstallPathSearch32" Path="IIS Express" AssignToProperty="yes">
                       <FileSearch Id="IISExpressExe32" Name="iisexpress.exe" />
                   </DirectorySearch>
                </DirectorySearch>
            </Property>

            <Property Id="IISEXPRESS_APPHOST_CONFIG32" Secure="yes">
                <DirectorySearchRef Id="ProgramFilesSearch32" Path="[ProgramFilesFolder]">
                   <DirectorySearch Id="IISExpressAppServerPathSearch32" Path="IIS Express\AppServer">
                      <FileSearch Id="AppHostConfig32" Name="applicationhost.config" />
                   </DirectorySearch>
                </DirectorySearchRef>
            </Property>

            <Property Id="IISEXPRESS_APPHOST_CONFIG_TMP32" Secure="yes">
                <DirectorySearchRef Id="ProgramFilesSearch32" Path="[ProgramFilesFolder]">
                   <DirectorySearch Id="IISExpressTmpPathSearch32" Path="IIS Express\config\templates\PersonalWebServer">
                      <FileSearch Id="AppHostConfigTmp32" Name="applicationhost.config" />
                   </DirectorySearch>
                </DirectorySearchRef>
            </Property>

           <SetProperty Id="INSTALLDIR32" Value="[IISEXPRESS_INSTALL_PATH32]" After="CostInitialize" />
        <?endif?>

        <!-- Directory Structure and Component Definitions -->
        <DirectoryRef Id="INSTALLDIR">
          <Directory Id="INSTALLLOCATION" ShortName="ANCM" Name="$(ProductName)">
            <Directory Id="VersionDir" Name="$(ProductVersionString)">
              <Component Id="AspNetCoreModule" Guid="84ed6ce6-c8a3-4fa8-a872-c98a1d15dd4f" Bitness="$(Bitness)">
                  <?if $(InstallerPlatform) = "arm64" ?>
                  <File Id="AspNetCoreModuleDll" Name="aspnetcorev2.dll" Source="$(ArtifactsDir)\bin\AspNetCoreModuleForwarders\aspnetcorev2.dll" DiskId="1" Vital="yes" KeyPath="yes"/>
                  <?else?>
                  <File Id="AspNetCoreModuleDll" Name="aspnetcorev2.dll" Source="$(AspNetCoreV2ProgramFilesTargetPath)" DiskId="1" Vital="yes" KeyPath="yes"/>
                  <?endif?>
                <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\EventLog\Application\$(ProductShortName)">
                  <RegistryValue Name="EventMessageFile" Type="expandable" Value="[#AspNetCoreModuleDll]" />
                  <RegistryValue Name="TypesSupported" Type="integer" Value="7" />
                </RegistryKey>
              </Component>
              <Directory Id="HandlerVersionDir" Name="$(ANCMFolderVersion)">
                <Component Id="AspNetCoreModuleHandler" Guid="559EF726-B25C-480F-AFA4-32D0BA8B2376" Bitness="$(Bitness)">
                      <?if $(InstallerPlatform) = "arm64" ?>
                      <File Id="AspNetCoreModuleHandlerDll" Name="aspnetcorev2_outofprocess.dll" Source="$(ArtifactsDir)\bin\AspNetCoreModuleForwarders\aspnetcorev2_outofprocess.dll" DiskId="1" Vital="yes" />
                      <?else?>
                      <File Id="AspNetCoreModuleHandlerDll" Name="aspnetcorev2_outofprocess.dll" Source="$(AspNetCoreV2HandlerProgramFilesTargetPath)" DiskId="1" Vital="yes">
                      </File>
                      <?endif?>
                </Component>
                <?if $(InstallerPlatform) = "arm64" ?>
                  <Component Id="AspNetCoreModuleHandler.x64" Guid="0b192457-9c6a-4703-ba6a-0c5a58b7c9cb" Bitness="$(Bitness)">
                      <File Id="AspNetCoreModuleHandlerDll.x64" Name="aspnetcorev2_outofprocess_x64.dll" Source="$(ArtifactsDir)\bin\OutOfProcessRequestHandler\x64\$(Configuration)\aspnetcorev2_outofprocess.dll" DiskId="1" Vital="yes" />
                  </Component>
                  <Component Id="AspNetCoreModuleHandler.arm64" Guid="21cc9da0-ab0a-4717-90df-dbaaa3f68510" Bitness="$(Bitness)">
                    <File Id="AspNetCoreModuleHandlerDll.arm64" Name="aspnetcorev2_outofprocess_arm64.dll" Source="$(AspNetCoreV2HandlerProgramFilesTargetPath)" DiskId="1" Vital="yes" />
                  </Component>
                <?endif?>
              </Directory>
              <?if $(InstallerPlatform) = "arm64" ?>
              <Component Id="AspNetCoreModuleV2.x64" Guid="1962b1b0-6345-4b37-97b3-a8f2c9e82bee" Bitness="$(Bitness)">
                  <File Id="AspNetCoreModuleV2Dll.x64" Name="aspnetcorev2_x64.dll" Source="$(ArtifactsDir)\bin\AspNetCoreModuleShim\x64\$(Configuration)\aspnetcorev2.dll" DiskId="1" Vital="yes" KeyPath="yes"/>
                  <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\EventLog\Application\$(ProductShortName)">
                      <RegistryValue Name="EventMessageFile" Type="expandable" Value="[#AspNetCoreModuleV2Dll.x64]" />
                      <RegistryValue Name="TypesSupported" Type="integer" Value="7" />
                  </RegistryKey>
              </Component>
              <Component Id="AspNetCoreModuleV2.arm64" Guid="22f16c6c-7c53-422c-8ad5-831e4870a44e" Bitness="$(Bitness)">
                  <File Id="AspNetCoreModuleV2Dll.arm64" Name="aspnetcorev2_arm64.dll" Source="$(AspNetCoreV2ProgramFilesTargetPath)" DiskId="1" Vital="yes" KeyPath="yes" />
                  <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\EventLog\Application\$(ProductShortName)">
                      <RegistryValue Name="EventMessageFile" Type="expandable" Value="[#AspNetCoreModuleV2Dll.arm64]" />
                      <RegistryValue Name="TypesSupported" Type="integer" Value="7" />
                  </RegistryKey>
              </Component>
              <?endif?>
            </Directory>
          </Directory>
          <Directory Id="IISConfigDir" Name="config">
            <Directory Id="IISSchemaDir" Name="schema">
              <Component Id="AspNetCoreSchema" Guid="$(SchemaGuid)" Bitness="$(Bitness)">
                <File Id="AspNetCoreSchemaFile" Name="aspnetcore_schema_v2.xml" Source="$(AspNetCoreSchemaPath)" DiskId="1" Vital="yes" />
              </Component>
            </Directory>
          </Directory>

          <!-- WOW64 Support -->
          <?if $(InstallerPlatform) != "x86" ?>
          <Directory Id="ProgramFilesFolder">
            <Directory Id="INSTALLDIR32" Name="IIS Express">
              <Directory Id="INSTALLLOCATION32" ShortName="ANCM" Name="$(ProductName)">
                <Directory Id="VersionDir32" Name="$(ProductVersionString)">
                  <!-- Originally created with same component GUID as IIS installer. Must remain the same so upgrade doesn't remove this file -->
                  <Component Id="AspNetCoreModule.wow" Guid="45ba5011-a619-4d06-8a8d-155b1f9732b3" Bitness="always32">
                    <File Id="AspNetCoreModuleDll.wow" Name="aspnetcorev2.dll" Source="$(ArtifactsDir)\bin\AspNetCoreModuleShim\Win32\$(Configuration)\aspnetcorev2.dll" DiskId="1" Vital="yes">
                    </File>
                    <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\EventLog\Application\$(ProductShortName)">
                      <RegistryValue Name="EventMessageFile" Type="expandable" Value="[#AspNetCoreModuleDll.wow]" />
                      <RegistryValue Name="TypesSupported" Type="integer" Value="7" />
                    </RegistryKey>
                  </Component>
                  <Directory Id="HandlerVersionDir32" Name="$(ANCMFolderVersion)">
                    <Component Id="AspNetCoreModuleHandler.wow" Guid="0A8EDB50-7D85-4825-8010-D27EFAF061B6" Bitness="always32">
                      <File Id="AspNetCoreModuleHandlerDll.wow" Name="aspnetcorev2_outofprocess.dll" Source="$(ArtifactsDir)\bin\OutOfProcessRequestHandler\Win32\$(Configuration)\aspnetcorev2_outofprocess.dll" DiskId="1" Vital="yes">
                      </File>
                    </Component>
                  </Directory>
                </Directory>
              </Directory>
              <Directory Id="IISConfigDir.wow" Name="config">
                <Directory Id="IISSchemaDir.wow" Name="schema">
                  <Component Id="AspNetCoreSchema.wow" Guid="$(SchemaGuid32)" Bitness="always32">
                    <File Id="AspNetCoreSchemaFile.wow" Name="aspnetcore_schema_v2.xml" Source="$(AspNetCoreSchemaPath)" DiskId="1" Vital="yes" />
                  </Component>
                </Directory>
              </Directory>
            </Directory>
          </Directory>
          <?endif?>
        </DirectoryRef>

        <!-- Feature Definition -->
        <Feature Id="AspNetCoreModuleFeature" Title="!(loc.AspNetCoreModuleProductTitle)" Description="!(loc.AspNetCoreModuleProductDescription)" Level="1">
            <ComponentRef Id="AspNetCoreModule" />
            <ComponentRef Id="AspNetCoreModuleHandler" />
            <?if $(InstallerPlatform) = "arm64" ?>
            <ComponentRef Id="AspNetCoreModuleV2.x64" />
            <ComponentRef Id="AspNetCoreModuleHandler.x64" />
            <ComponentRef Id="AspNetCoreModuleV2.arm64" />
            <ComponentRef Id="AspNetCoreModuleHandler.arm64" />
            <?endif?>
            <ComponentRef Id="AspNetCoreSchema" />
            <?if $(InstallerPlatform) != "x86" ?>
                <ComponentRef Id="AspNetCoreModule.wow" />
                <ComponentRef Id="AspNetCoreModuleHandler.wow" />
                <ComponentRef Id="AspNetCoreSchema.wow" />
            <?endif?>
        </Feature>

        <!-- User Interface -->
        <ui:WixUI Id="WixUI_Minimal" />
        <UIRef Id="WixUI_ErrorProgressText" />

        <UI>
            <DialogRef Id="WelcomeEulaDlg" />

            <!--CUSTOM errors specific to OOB setup-->
            <Error Id="30001" Message="!(loc.Error30001)" />
            <Error Id="30002" Message="!(loc.Error30002)" />
            <!-- Require WAS and WMSVC be stopped to avoid restarts -->
            <Error Id="30003" Message="!(loc.WebServicesRunning)" />
        </UI>

        <!-- Standard IIS Custom Actions -->

        <SetProperty Id="INSTALLDIR" Value="[IISEXPRESS_INSTALL_PATH]" After="CostInitialize" />

        <!--   All this magic just to set the handlers section OverrideModeDefault=allow -->
        <CustomAction Id="CA_UNLOCK_HANDLER_PROPERTY" Property="CA_UNLOCK_HANDLER" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; unlock config /section:system.webserver/handlers /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_UNLOCK_HANDLER" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />
        <CustomAction Id="CA_UNLOCK_HANDLER_TMP_PROPERTY" Property="CA_UNLOCK_HANDLER_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; unlock config /section:system.webserver/handlers /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_UNLOCK_HANDLER_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <!-- CA's to install/add module in appserver/applicationhost.config -->
        <CustomAction Id="CA_UNINSTALL_MODULE_PROPERTY" Property="CA_UNINSTALL_MODULE" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_UNINSTALL_MODULE" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ADD_MODULE_PROPERTY" Property="CA_ADD_MODULE" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; install module /name:$(AspNetCoreModuleName) /image:&quot;%IIS_BIN%\$(ProductName)\$(ProductVersionString)\aspnetcorev2.dll&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_ADD_MODULE" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ROLLBACK_MODULE_PROPERTY" Property="CA_ROLLBACK_MODULE" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_ROLLBACK_MODULE" DllEntry="WixQuietExec" Execute="rollback" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_SET_MODULE_PROPERTY" Property="CA_SET_MODULE" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set module $(AspNetCoreModuleName) /lockItem:true /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_SET_MODULE" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_REMOVE_MODULE_PROPERTY" Property="CA_REMOVE_MODULE" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_REMOVE_MODULE" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION_PROPERTY" Property="CA_ADD_TRACE_PROVIDER_DEFINITION" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /+&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION_PROPERTY" Property="CA_REMOVE_TRACE_PROVIDER_DEFINITION" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /-&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <!-- CAs to install/add module in config/templates/.../applicationhost.config -->
        <CustomAction Id="CA_UNINSTALL_MODULE_TMP_PROPERTY" Property="CA_UNINSTALL_MODULE_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_UNINSTALL_MODULE_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ADD_MODULE_TMP_PROPERTY" Property="CA_ADD_MODULE_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; install module /name:$(AspNetCoreModuleName) /image:&quot;%IIS_BIN%\$(ProductName)\$(ProductVersionString)\aspnetcorev2.dll&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_ADD_MODULE_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ROLLBACK_MODULE_TMP_PROPERTY" Property="CA_ROLLBACK_MODULE_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_ROLLBACK_MODULE_TMP" DllEntry="WixQuietExec" Execute="rollback" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_SET_MODULE_TMP_PROPERTY" Property="CA_SET_MODULE_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set module $(AspNetCoreModuleName) /lockItem:true /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_SET_MODULE_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_REMOVE_MODULE_TMP_PROPERTY" Property="CA_REMOVE_MODULE_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_REMOVE_MODULE_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP_PROPERTY" Property="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /+&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP_PROPERTY" Property="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /-&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION_PROPERTY" Property="CA_UPDATE_DYNAMIC_COMPRESSION" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/httpCompression /+&quot;dynamicTypes.[\[]mimeType='text/event-stream',enabled='FALSE'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG]&quot;" />
        <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION_TMP_PROPERTY" Property="CA_UPDATE_DYNAMIC_COMPRESSION_TMP" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; set config -section:system.webServer/httpCompression /+&quot;dynamicTypes.[\[]mimeType='text/event-stream',enabled='FALSE'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP]&quot;" />
        <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION_TMP" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

        <CustomAction Id="CA_ADD_CONFIGSECTION_PROPERTY" Property="CA_ADD_CONFIGSECTION" Value="[IISEXPRESS_APPHOST_CONFIG]" />
        <CustomAction Id="CA_ADD_CONFIGSECTION" DllEntry="AddConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

        <CustomAction Id="CA_ADD_CONFIGSECTION_PROPERTY_TMP" Property="CA_ADD_CONFIGSECTION_TMP" Value="[IISEXPRESS_APPHOST_CONFIG_TMP]" />
        <CustomAction Id="CA_ADD_CONFIGSECTION_TMP" DllEntry="AddConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

        <CustomAction Id="CA_REMOVE_CONFIGSECTION_PROPERTY" Property="CA_REMOVE_CONFIGSECTION" Value="[IISEXPRESS_APPHOST_CONFIG]" />
        <CustomAction Id="CA_REMOVE_CONFIGSECTION" DllEntry="RemoveConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

        <CustomAction Id="CA_REMOVE_CONFIGSECTION_PROPERTY_TMP" Property="CA_REMOVE_CONFIGSECTION_TMP" Value="[IISEXPRESS_APPHOST_CONFIG_TMP]" />
        <CustomAction Id="CA_REMOVE_CONFIGSECTION_TMP" DllEntry="RemoveConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

        <?if $(InstallerPlatform) != "x86" ?>
            <CustomAction Id="CA_UNLOCK_HANDLER32_PROPERTY" Property="CA_UNLOCK_HANDLER32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; unlock config /section:system.webserver/handlers /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_UNLOCK_HANDLER32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />
            <CustomAction Id="CA_UNLOCK_HANDLER_TMP32_PROPERTY" Property="CA_UNLOCK_HANDLER_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; unlock config /section:system.webserver/handlers /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_UNLOCK_HANDLER_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <!-- CA's to install/add module in appserver/applicationhost.config -->

            <CustomAction Id="CA_UNINSTALL_MODULE32_PROPERTY" Property="CA_UNINSTALL_MODULE32" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_UNINSTALL_MODULE32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ADD_MODULE32_PROPERTY" Property="CA_ADD_MODULE32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; install module /name:$(AspNetCoreModuleName) /image:&quot;%IIS_BIN%\$(ProductName)\$(ProductVersionString)\aspnetcorev2.dll&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_ADD_MODULE32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ROLLBACK_MODULE32_PROPERTY" Property="CA_ROLLBACK_MODULE32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_ROLLBACK_MODULE32" DllEntry="WixQuietExec" Execute="rollback" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_SET_MODULE32_PROPERTY" Property="CA_SET_MODULE32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set module $(AspNetCoreModuleName) /lockItem:true /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_SET_MODULE32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_REMOVE_MODULE32_PROPERTY" Property="CA_REMOVE_MODULE32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_REMOVE_MODULE32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION32_PROPERTY" Property="CA_ADD_TRACE_PROVIDER_DEFINITION32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /+&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION32_PROPERTY" Property="CA_REMOVE_TRACE_PROVIDER_DEFINITION32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /-&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <!-- CAs to install/add module in config/templates/.../applicationhost.config -->
            <CustomAction Id="CA_UNINSTALL_MODULE_TMP32_PROPERTY" Property="CA_UNINSTALL_MODULE_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_UNINSTALL_MODULE_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ADD_MODULE_TMP32_PROPERTY" Property="CA_ADD_MODULE_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; install module /name:$(AspNetCoreModuleName) /image:&quot;%IIS_BIN%\$(ProductName)\$(ProductVersionString)\aspnetcorev2.dll&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_ADD_MODULE_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ROLLBACK_MODULE_TMP32_PROPERTY" Property="CA_ROLLBACK_MODULE_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_ROLLBACK_MODULE_TMP32" DllEntry="WixQuietExec" Execute="rollback" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_SET_MODULE_TMP32_PROPERTY" Property="CA_SET_MODULE_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set module $(AspNetCoreModuleName) /lockItem:true /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_SET_MODULE_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_REMOVE_MODULE_TMP32_PROPERTY" Property="CA_REMOVE_MODULE_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; uninstall module $(AspNetCoreModuleName) /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_REMOVE_MODULE_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32_PROPERTY" Property="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /+&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32_PROPERTY" Property="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/tracing/traceProviderDefinitions /-&quot;[\[]name='WWW Server'[\]].areas.[\[]name='$(AspNetCoreTraceProviderName)',value='$(AspNetCoreTraceProviderValue)'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG_TMP32]&quot;" />
            <CustomAction Id="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION32_PROPERTY" Property="CA_UPDATE_DYNAMIC_COMPRESSION32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/httpCompression /+&quot;dynamicTypes.[\[]mimeType='text/event-stream',enabled='FALSE'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32_PROPERTY" Property="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32" Value="&quot;[IISEXPRESS_INSTALL_PATH32]appcmd.exe&quot; set config -section:system.webServer/httpCompression /+&quot;dynamicTypes.[\[]mimeType='text/event-stream',enabled='FALSE'[\]]&quot; /apphostconfig:&quot;[IISEXPRESS_APPHOST_CONFIG32]&quot;" />
            <CustomAction Id="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" BinaryRef="Wix4UtilCA_X86" />

            <CustomAction Id="CA_ADD_CONFIGSECTION32_PROPERTY" Property="CA_ADD_CONFIGSECTION32" Value="[IISEXPRESS_APPHOST_CONFIG32]" />
            <CustomAction Id="CA_ADD_CONFIGSECTION32" DllEntry="AddConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

            <CustomAction Id="CA_ADD_CONFIGSECTION32_PROPERTY_TMP" Property="CA_ADD_CONFIGSECTION32_TMP" Value="[IISEXPRESS_APPHOST_CONFIG_TMP32]" />
            <CustomAction Id="CA_ADD_CONFIGSECTION32_TMP" DllEntry="AddConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

            <CustomAction Id="CA_REMOVE_CONFIGSECTION32_PROPERTY" Property="CA_REMOVE_CONFIGSECTION32" Value="[IISEXPRESS_APPHOST_CONFIG32]" />
            <CustomAction Id="CA_REMOVE_CONFIGSECTION32" DllEntry="RemoveConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />

            <CustomAction Id="CA_REMOVE_CONFIGSECTION32_PROPERTY_TMP" Property="CA_REMOVE_CONFIGSECTION32_TMP" Value="[IISEXPRESS_APPHOST_CONFIG_TMP32]" />
            <CustomAction Id="CA_REMOVE_CONFIGSECTION32_TMP" DllEntry="RemoveConfigSection" Execute="deferred" Return="check" Impersonate="no" BinaryRef="IISCustomActionDll" />
        <?endif?>

        <InstallExecuteSequence>
            <AppSearch Before="LaunchConditions" />
            <LaunchConditions After="FindRelatedProducts" />
            <MigrateFeatureStates />
            <Custom Action="CA_UNLOCK_HANDLER_PROPERTY" After="InstallFiles" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNLOCK_HANDLER" After="CA_UNLOCK_HANDLER_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNINSTALL_MODULE_PROPERTY" After="CA_UNLOCK_HANDLER" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNINSTALL_MODULE" After="CA_UNINSTALL_MODULE_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_MODULE_PROPERTY" After="CA_UNINSTALL_MODULE" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_MODULE" After="CA_ADD_MODULE_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ROLLBACK_MODULE_PROPERTY" Before="CA_ROLLBACK_MODULE" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ROLLBACK_MODULE" Before="CA_ADD_MODULE_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_SET_MODULE_PROPERTY" After="CA_ADD_MODULE" Condition="(NOT REMOVE)" />
            <Custom Action="CA_SET_MODULE" After="CA_SET_MODULE_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_CONFIGSECTION_PROPERTY" After="CA_SET_MODULE" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_CONFIGSECTION" After="CA_ADD_CONFIGSECTION_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_CONFIGSECTION_PROPERTY_TMP" After="CA_ADD_CONFIGSECTION" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_CONFIGSECTION_TMP" After="CA_ADD_CONFIGSECTION_PROPERTY_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION_PROPERTY" After="CA_ADD_CONFIGSECTION_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION" After="CA_ADD_TRACE_PROVIDER_DEFINITION_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP_PROPERTY" After="CA_ADD_TRACE_PROVIDER_DEFINITION" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP" After="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UPDATE_DYNAMIC_COMPRESSION_TMP_PROPERTY" After="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UPDATE_DYNAMIC_COMPRESSION_TMP" After="CA_UPDATE_DYNAMIC_COMPRESSION_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_REMOVE_MODULE_PROPERTY" Before="CA_REMOVE_MODULE" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_MODULE" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_CONFIGSECTION_PROPERTY" Before="CA_REMOVE_CONFIGSECTION" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_CONFIGSECTION" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_CONFIGSECTION_PROPERTY_TMP" Before="CA_REMOVE_CONFIGSECTION_TMP" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_CONFIGSECTION_TMP" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION_PROPERTY" Before="CA_REMOVE_TRACE_PROVIDER_DEFINITION" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP_PROPERTY" Before="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_UNLOCK_HANDLER_TMP_PROPERTY" After="CA_ADD_CONFIGSECTION" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNLOCK_HANDLER_TMP" After="CA_UNLOCK_HANDLER_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNINSTALL_MODULE_TMP_PROPERTY" After="CA_UNLOCK_HANDLER_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_UNINSTALL_MODULE_TMP" After="CA_UNINSTALL_MODULE_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_MODULE_TMP_PROPERTY" After="CA_UNINSTALL_MODULE_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ADD_MODULE_TMP" After="CA_ADD_MODULE_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ROLLBACK_MODULE_TMP_PROPERTY" Before="CA_ROLLBACK_MODULE_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_ROLLBACK_MODULE_TMP" Before="CA_ADD_MODULE_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_SET_MODULE_TMP_PROPERTY" After="CA_ADD_MODULE_TMP" Condition="(NOT REMOVE)" />
            <Custom Action="CA_SET_MODULE_TMP" After="CA_SET_MODULE_TMP_PROPERTY" Condition="(NOT REMOVE)" />
            <Custom Action="CA_REMOVE_MODULE_TMP_PROPERTY" Before="CA_REMOVE_MODULE_TMP" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <Custom Action="CA_REMOVE_MODULE_TMP" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />

            <?if $(InstallerPlatform) != "x86" ?>
                <Custom Action="CA_UNLOCK_HANDLER32_PROPERTY" After="InstallFiles" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNLOCK_HANDLER32" After="CA_UNLOCK_HANDLER32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNINSTALL_MODULE32_PROPERTY" After="CA_UNLOCK_HANDLER32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNINSTALL_MODULE32" After="CA_UNINSTALL_MODULE32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ADD_MODULE32_PROPERTY" After="CA_UNINSTALL_MODULE32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ADD_MODULE32" After="CA_ADD_MODULE32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ROLLBACK_MODULE32_PROPERTY" Before="CA_ROLLBACK_MODULE32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ROLLBACK_MODULE32" Before="CA_ADD_MODULE32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_SET_MODULE32_PROPERTY" After="CA_ADD_MODULE32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_SET_MODULE32" After="CA_ADD_MODULE32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ADD_CONFIGSECTION32_PROPERTY" After="CA_SET_MODULE32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_CONFIGSECTION32" After="CA_ADD_CONFIGSECTION32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_CONFIGSECTION32_PROPERTY_TMP" After="CA_ADD_CONFIGSECTION32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_CONFIGSECTION32_TMP" After="CA_ADD_CONFIGSECTION32_PROPERTY_TMP" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION32_PROPERTY" After="CA_ADD_CONFIGSECTION32_TMP" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION32" After="CA_ADD_TRACE_PROVIDER_DEFINITION32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32_PROPERTY" After="CA_ADD_TRACE_PROVIDER_DEFINITION32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32" After="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32_PROPERTY" After="CA_ADD_TRACE_PROVIDER_DEFINITION_TMP32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32" After="CA_UPDATE_DYNAMIC_COMPRESSION_TMP32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_REMOVE_MODULE32_PROPERTY" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND IISEXPRESS_INSTALL_PATH32 AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_MODULE32" After="CA_REMOVE_MODULE32_PROPERTY" Condition="(REMOVE~=&quot;ALL&quot; AND IISEXPRESS_INSTALL_PATH32 AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_CONFIGSECTION32_PROPERTY" Before="CA_REMOVE_CONFIGSECTION32" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_CONFIGSECTION32" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_CONFIGSECTION32_PROPERTY_TMP" Before="CA_REMOVE_CONFIGSECTION32_TMP" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_CONFIGSECTION32_TMP" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION32_PROPERTY" Before="CA_REMOVE_TRACE_PROVIDER_DEFINITION32" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION32" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32_PROPERTY" Before="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_TRACE_PROVIDER_DEFINITION_TMP32" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_UNLOCK_HANDLER_TMP32_PROPERTY" After="CA_ADD_CONFIGSECTION32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNLOCK_HANDLER_TMP32" After="CA_UNLOCK_HANDLER_TMP32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNINSTALL_MODULE_TMP32_PROPERTY" After="CA_UNLOCK_HANDLER_TMP32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_UNINSTALL_MODULE_TMP32" After="CA_UNINSTALL_MODULE_TMP32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ADD_MODULE_TMP32_PROPERTY" After="CA_UNINSTALL_MODULE_TMP32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ADD_MODULE_TMP32" After="CA_ADD_MODULE_TMP32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_ROLLBACK_MODULE_TMP32_PROPERTY" Before="CA_ROLLBACK_MODULE_TMP32" Condition="(NOT REMOVE)" />
                <Custom Action="CA_ROLLBACK_MODULE_TMP32" Before="CA_ADD_MODULE_TMP32_PROPERTY" Condition="(NOT REMOVE)" />
                <Custom Action="CA_SET_MODULE_TMP32_PROPERTY" After="CA_ADD_MODULE_TMP32" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_SET_MODULE_TMP32" After="CA_SET_MODULE_TMP32_PROPERTY" Condition="(NOT REMOVE AND IISEXPRESS_INSTALL_PATH32)" />
                <Custom Action="CA_REMOVE_MODULE_TMP32_PROPERTY" Before="CA_REMOVE_MODULE_TMP32" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
                <Custom Action="CA_REMOVE_MODULE_TMP32" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE)" />
            <?endif?>
            <RemoveExistingProducts After="InstallFinalize" />
        </InstallExecuteSequence>

        <FeatureRef Id="FT_DepProvider_$(ProductNameShort)" />

        <StandardDirectory Id="ProgramFiles6432Folder">
            <Directory Id="INSTALLDIR" Name="IIS Express" />
        </StandardDirectory>
    </Package>

    <Fragment>
        <Feature Id="FT_DepProvider_$(ProductNameShort)" AllowAdvertise="no" Description="Used for Ref Counting" Display="hidden" InstallDefault="local" Level="1" Title="RefCounting" TypicalDefault="install" AllowAbsent="no">
            <Component Id="C_DepProvider_$(ProductNameShort)" Directory="TARGETDIR" Bitness="always32" Guid="$(DepProviderGuid)">
                <Provides Key="$(ANCMDepProviderKey)" dep:Check="yes" />
            </Component>
        </Feature>
    </Fragment>

    <Fragment>
        <Binary Id="IISCustomActionDll" SourceFile="$(aspnetcoreCA.TargetPath)" />
    </Fragment>

</Wix>