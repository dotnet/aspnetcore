// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.

using Microsoft.Extensions.Validation.GeneratorTests;
using VerifyXunit;
using Xunit;

namespace Microsoft.Extensions.Validation.GeneratorTests;

[UsesVerify]
public partial class ValidationsGeneratorTests : ValidationsGeneratorTestBase
{
    [Fact]
    public async Task CanUseAutoGeneratedValidatableTypeAttribute()
    {
        var source = """
            using Microsoft.AspNetCore.Builder;
            using Microsoft.Extensions.DependencyInjection;
            using System.ComponentModel.DataAnnotations;

            var builder = WebApplication.CreateBuilder();
            builder.Services.AddValidation();
            var app = builder.Build();

            // Using the auto-generated ValidatableTypeAttribute
            // No manual attribute definition needed!
            [ValidatableType]
            public class Customer
            {
                [Required]
                public string Name { get; set; } = "";

                [EmailAddress]
                public string Email { get; set; } = "";
            }

            app.MapPost("/customers", (Customer customer) => "OK");

            app.Run();
            """;

        await Verify(source, out var compilation, globalOptions: new Dictionary<string, string>
        {
            ["build_property.RootNamespace"] = "TestApp",
            ["build_property.GenerateBuiltinValidatableTypeAttribute"] = "true"
        });
    }
}
