<!--
  This file filters test projects based on the AffectedTestAreas property.
  When AffectedTestAreas is set (semicolon-delimited list of area names), only test projects
  belonging to those areas are included in the build/test. When not set, all tests run.

  This is imported from Build.props after project items are defined.
-->
<Project>
  <!--
    Define a custom inline task to filter project items by area.
    This is needed because MSBuild's static evaluation can't express
    "keep items matching any of N path prefixes" cleanly.
  -->
  <UsingTask TaskName="FilterProjectsByArea" TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll"
             Condition=" '$(AffectedTestAreas)' != '' ">
    <ParameterGroup>
      <Projects ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <AffectedAreas ParameterType="System.String" Required="true" />
      <SrcRoot ParameterType="System.String" Required="true" />
      <FilteredProjects ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        var areas = new System.Collections.Generic.HashSet<string>(
            AffectedAreas.Split(new[] { ';' }, System.StringSplitOptions.RemoveEmptyEntries),
            System.StringComparer.OrdinalIgnoreCase);

        var result = new System.Collections.Generic.List<Microsoft.Build.Framework.ITaskItem>();
        var srcPrefix = SrcRoot.TrimEnd('\\', '/') + System.IO.Path.DirectorySeparatorChar;

        foreach (var project in Projects)
        {
            var fullPath = project.GetMetadata("FullPath");
            if (string.IsNullOrEmpty(fullPath))
                fullPath = project.ItemSpec;

            // Keep projects not under src/ (e.g., eng/ tools)
            if (!fullPath.StartsWith(srcPrefix, System.StringComparison.OrdinalIgnoreCase))
            {
                result.Add(project);
                continue;
            }

            // Extract the area name (first directory segment under src/)
            var relativePath = fullPath.Substring(srcPrefix.Length);
            var separatorIndex = relativePath.IndexOfAny(new[] { '\\', '/' });
            if (separatorIndex < 0)
            {
                result.Add(project);
                continue;
            }

            var projectArea = relativePath.Substring(0, separatorIndex);
            if (areas.Contains(projectArea))
            {
                result.Add(project);
            }
        }

        FilteredProjects = result.ToArray();
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <!--
    Filter ProjectToBuild items before tests are gathered or executed.
    This target runs before the Helix Gather target and before Build/Test targets.
  -->
  <Target Name="FilterTestProjectsByAffectedAreas"
          BeforeTargets="Gather;Build;Test;Restore"
          Condition=" '$(AffectedTestAreas)' != '' ">
    <Message Importance="High" Text="Filtering test projects to affected areas: $(AffectedTestAreas)" />

    <FilterProjectsByArea
        Projects="@(ProjectToBuild)"
        AffectedAreas="$(AffectedTestAreas)"
        SrcRoot="$(RepoRoot)src">
      <Output TaskParameter="FilteredProjects" ItemName="_FilteredProjectToBuild" />
    </FilterProjectsByArea>

    <ItemGroup>
      <ProjectToBuild Remove="@(ProjectToBuild)" />
      <ProjectToBuild Include="@(_FilteredProjectToBuild)" />
    </ItemGroup>

    <Message Importance="High"
             Text="After filtering: @(ProjectToBuild->Count()) projects remaining for affected areas" />
  </Target>
</Project>

