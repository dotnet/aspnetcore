<Project>

  <Target Name="Publish" DependsOnTargets="$(PublishDependsOn)" />

  <!-- Builds and uploads VSIX packages manifests to VS drop share -->
  <Target Name="RunVSDrop" DependsOnTargets="GetToolsets" Condition="'$(PublishToVSDrop)' == 'true'">
    <Error Text="Cannot publish unsigned files to VS drops. Set SignType to 'real' to ensuring files are signed first."
      Condition=" '$(SignType)' != 'real'" />

    <Error Text="MSBuild could not be located."
      Condition="'$(VisualStudioMSBuildx86Path)'==''" />

    <ItemGroup>
      <SignedVSIX Include="$(SignedVSIXPath)**\*.vsix" />
    </ItemGroup>

    <MSBuild Condition=" @(SignedVSIX->Count()) != 0 "
      Projects="$(MSBuildProjectFullPath)"
      Targets="_PublishVsixToVsDrop"
      Properties="VisualStudioMSBuildx86Path=$(VisualStudioMSBuildx86Path);SignedVSIXFileName=%(SignedVSIX.FileName)" />
  </Target>

  <Target Name="_PublishVsixToVsDrop">
    <ItemGroup>
      <MSBuildExeArgs Remove="@(MSBuildExeArgs)" />
      <MSBuildExeArgs Include="
        $(MSBuildThisFileDirectory)vsdrop\drop.msbuild;
        /t:BuildAndPublishManifest;
        /p:VsixName=$(SignedVsixFileName);
        /p:SignedVsixPath=$(SignedVSIXPath);
        /p:RepositoryRoot=$(RepositoryRoot);
        /p:ManifestRepositoryName=AspNetCore/$(SignedVsixFileName);
        /p:ManifestBuildBranch=$(BuildBranch);
        /p:ManifestBuildNumber=$(BuildNumber)" />
    </ItemGroup>

    <Message Text="Publishing VSIX $(SignedVsixFileName) to VS Drops" Importance="high" />
    <Run FileName="$(VisualStudioMSBuildx86Path)" Arguments="@(MSBuildExeArgs)" />
  </Target>

</Project>
