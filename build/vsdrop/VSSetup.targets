<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Import Project="VSSetup.props" Condition="'$(VSSetupProps)' != '1'"/>

    <ItemGroup>
        <VSSetupPackages Include="MicroBuild.Plugins.SwixBuild">
            <Source>"https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json"</Source>
        </VSSetupPackages>
        <VSSetupPackages Include="Microsoft.Wix4.Tools">
            <Source>"https://mseng.pkgs.visualstudio.com/_packaging/VS/nuget/v3/index.json"</Source>
        </VSSetupPackages>
        <VSSetupPackages Include="Drop.App">
            <Source>"https://mseng.pkgs.visualstudio.com/_packaging/Artifact-Release/nuget/v3/index.json"</Source>
        </VSSetupPackages>
    </ItemGroup>

    <!-- Restore packages need to run various commands for SWIX, Drop publishing, etc. -->
    <Target Name="VSSetupRestorePackages">
        <Error Text="NuGetExe is undefined or does not exist: $(NuGetExe)" Condition="'$(NuGetExe)' == '' OR !EXISTS('$(NuGetExe)')" />

        <Exec Command="$(NuGetExe) install %(VSSetupPackages.Identity) -source %(Source) -excludeversion -outputdirectory $(VSSetupPackagesRestorePath) -noninteractive -prerelease" />
    </Target>

    <Target Name="BuildManifests" DependsOnTargets="GetManifests">
        <MSBuild Projects="%(VsmanProjectsToBuild.Identity)" Properties="WorkingDirectory=$(WorkingDirectory);ManifestSrc=%(ManifestSrc);OutputPath=%(OutputPath)" />
    </Target>

    <Target Name="PublishToVSDrop" DependsOnTargets="GetDropCmdLine">
        <Exec Command="$(DropListCmd)" ConsoleToMSBuild="true">
          <Output TaskParameter="ConsoleOutput" PropertyName="DropListOutput" />
        </Exec>

        <PropertyGroup>
          <InvokePublishToVSDropCore Condition="$(DropListOutput.Contains('$(DropName)'))">false</InvokePublishToVSDropCore>
        </PropertyGroup>

        <!-- drop.exe list -p $(DropName) prints the "DropName" if the file is already on the drop.
        We'll use that to determine if we need to publish a drop. This allows us to perform rebuilds of this repo without
        incrementing the build number -->
        <CallTarget Targets="PublishToVSDropCore" Condition="'$(InvokePublishToVSDropCore)'!='false'" />

        <Message Text="Skipping PublishTOVSDropCore since the drop is already present.%0aOutput from list command: $(DropListOutput)"
            Condition="'$(InvokePublishToVSDropCore)'=='false'"
            Importance="High" />


        <WriteLinesToFile File="$(VSDropTxt)" Overwrite="true" Lines="" />
    </Target>

    <Target Name="PublishToVSDropCore" DependsOnTargets="GetDropCmdLine">
        <Exec Command="$(DropUpgradeCmd)" />
        <Exec Command="$(DropCreateCmd)" />
        <Exec Command="$(DropPublishCmd)" />
        <Exec Command="$(DropFinalizeCmd)" />
        <Exec Command="$(DropUpdateCmd)" />
    </Target>

    <Target Name="GetDropCmdLine">
        <!-- Properties that will depend on each build configuration. We can only build the commandlines onces these are defined -->
        <Error Text="DropSource property undefined" Condition="'$(DropSource)' == ''" />

        <PropertyGroup>
            <DropName>Products/$(ManifestTeamProject)/$(ManifestRepositoryName)/$(ManifestBuildBranch)/$(ManifestBuildNumber)</DropName>

            <DropParamName>-n &quot;$(DropName)&quot;</DropParamName>
            <DropParamSource>-d &quot;$(DropSource)&quot;</DropParamSource>

            <DropListCmd>$(DropExe) List $(DropParamService) $(DropParamAuth) $(DropParamTimeout) -b -p &quot;$(DropName)&quot;</DropListCmd>

            <DropUpgradeCmd>$(DropExe) Upgrade $(DropParamService) $(DropParamAuth) $(DropParamTimeout) $(DropParamTraceLevel)</DropUpgradeCmd>
            <DropCreateCmd>$(DropExe) Create $(DropParamService) $(DropParamAuth) $(DropParamTimeout) $(DropParamTraceLevel) $(DropParamExpirationDate) $(DropParamName)</DropCreateCmd>
            <DropPublishCmd>$(DropExe) Publish $(DropParamService) $(DropParamAuth) $(DropParamTimeout) $(DropParamTraceLevel) $(DropParamName) $(DropParamSource)</DropPublishCmd>
            <DropFinalizeCmd>$(DropExe) Finalize $(DropParamService) $(DropParamAuth) $(DropParamTimeout) $(DropParamTraceLevel) $(DropParamName)</DropFinalizeCmd>
            <DropUpdateCmd>$(DropExe) Update $(DropParamService) $(DropParamAuth) $(DropParamTimeout) $(DropParamTraceLevel) $(DropParamName) --neverExpire</DropUpdateCmd>
        </PropertyGroup>
    </Target>

    <Target Name="VSSetupDiagnostic" DependsOnTargets="GetDropCmdLine">
        <ItemGroup>
            <VSSetupProperties Include="Drop cmd: $(DropUpgradeCmd)" />
            <VSSetupProperties Include="Drop cmd: $(DropCreateCmd)" />
            <VSSetupProperties Include="Drop cmd: $(DropPublishCmd)" />
            <VSSetupProperties Include="Drop cmd: $(DropFinalizeCmd)" />
            <VSSetupProperties Include="Drop cmd: $(DropUpdateCmd)" />
            <VSSetupProperties Include="DropName: $(DropName)" />
        </ItemGroup>

        <Message Text="%(VSSetupProperties.Identity)" />
    </Target>
</Project>
