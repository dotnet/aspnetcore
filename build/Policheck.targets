<Project>
  <PropertyGroup>
    <_PoliCheckOutputFile>$(IntermediateDir)policheck_results.xml</_PoliCheckOutputFile>
  </PropertyGroup>

  <Target Name="PoliCheck" DependsOnTargets="_GetPolicheckSettings;_CorePolicheck;_VerifyPolicheckResults" Condition=" '$(SkipPolicheck)' != 'true' " />

  <Target Name="_GetPolicheckSettings">
    <!-- These are terms that appear frequently but are not used offensively e.g. red is a color constant name. -->
    <PropertyGroup>
      <Exclusions>countries;country;race</Exclusions>
      <!-- Refers to the browser. -->
      <Exclusions>$(Exclusions);Edge</Exclusions>
    </PropertyGroup>

    <ItemGroup>
      <PolicheckFiles Include="$(PoliCheckPath)**\*" />
      <!-- incremental builds fail due to max path checks. https://github.com/Microsoft/msbuild/issues/53 -->
      <PolicheckFiles Remove="%(PolicheckFiles.FullPath)" Condition="!Exists(%(PolicheckFiles.FullPath))" />

      <!-- List is sorted OrdinalIgnoreCase. Path must be the relative path (non-wildcard) of the file inside the symbols nupkg -->

      <SrcExclusions Include="Angular-CSharp\ClientApp\package.json">
        <term>ssr</term>
        <Justification>Refers to server side rendering.</Justification>
      </SrcExclusions>
      <SrcExclusions Include="
        src\Microsoft.AspNetCore.TestHost\ResponseStream.cs;
        src\Microsoft.AspNetCore.Server.IntegrationTesting\Deployers\IISExpressDeployer.cs;
        src\Microsoft.AspNetCore.Server.IntegrationTesting\Deployers\SelfHostDeployer.cs">
        <term>hang</term>
        <Justification>Refers to a stuck process/thread.</Justification>
      </SrcExclusions>
      <SrcExclusions Include="
        src\Microsoft.AspNetCore.Mvc.DataAnnotations\Internal\DataAnnotationsMetadataProvider.cs;
        src\Microsoft.CodeAnalysis.Razor.Workspaces\ProjectSystem\DefaultProjectSnapshotManager.cs">
        <term>hanging</term>
        <Justification>Refers to a stuck process/thread.</Justification>
      </SrcExclusions>
      <SrcExclusions Include="
        src\Microsoft.AspNetCore.Http.Connections\HttpConnectionManager.cs">
        <term>hung</term>
        <Justification>Refers to a stuck process/thread.</Justification>
      </SrcExclusions>
      <SrcExclusions Include="
        src\EFCore.Specification.Tests\TestModels\ConcurrencyModel\F1Context.cs">
        <term>ho</term>
        <Justification>Part of a name</Justification>
      </SrcExclusions>
    </ItemGroup>

    <ItemGroup>
      <!-- Path must be the relative path (non-wildcard) of the file inside the symbols nupkg -->
      <FileExclusions Include="
        src\EFCore.Specification.Tests\TestModels\Northwind\NorthwindData.Objects.cs">
        <Justification>Northwind database contains too many violations to track them individually.</Justification>
      </FileExclusions>

      <!-- Paths using wildcards must use $(PoliCheckPath) as the base for MSBuild to be happy -->
      <FileExclusions Include="
        $(PoliCheckPath)**\System.Text.Encoding.CodePages.dll;
        $(PoliCheckPath)**\System.Text.Encodings.Web.dll;">
        <Justification>These BCL libraries includes geopolitical terms to support localized code pages.</Justification>
      </FileExclusions>

      <FileExclusions Include="
        $(PoliCheckPath)**\jquery\dist\jquery.js;
        $(PoliCheckPath)**\jquery-validation\dist\additional-methods*.js">
        <Justification>Third party code shipping in our packages</Justification>
      </FileExclusions>
      <FileExclusions Include="$(PoliCheckPath)**\*.deps.json">
        <Justification>Contains generated shasums in base64 which may contain violations.</Justification>
      </FileExclusions>
    </ItemGroup>
  </Target>

  <Target Name="_CorePolicheck"
          Inputs="@(PolicheckFiles)"
          Outputs="$(_PoliCheckOutputFile)">

    <PropertyGroup>
      <_PoliCheckDirectory>$(MSBuildProgramFiles32)\Microsoft\Policheck\</_PoliCheckDirectory>
      <_PoliCheckDirectory Condition="!Exists('$(_PoliCheckDirectory)')">$(ProgramFiles)\Microsoft\Policheck\</_PoliCheckDirectory>
      <_PoliCheckFileTypesPath>$(_PoliCheckDirectory)Config\FTSets.xml</_PoliCheckFileTypesPath>
      <_PoliCheckExe>$(_PoliCheckDirectory)policheck.exe</_PoliCheckExe>

      <_PoliCheckArguments>/f:&quot;$(PoliCheckPath.TrimEnd('\'))&quot; /t:"9" /o:&quot;$(_PoliCheckOutputFile)&quot; /ge:0 /pe:0 /fc:1 /xs:1</_PoliCheckArguments>
    </PropertyGroup>

    <Error
      Text="Policheck.exe could not be found. See http://toolbox/policheck for installation instructions."
      Condition="!Exists('$(_PoliCheckExe)') AND '$(LocalBuild)'!='true'" />

    <Warning
      Text="Policheck.exe could not be found. See http://toolbox/policheck for installation instructions. Proceeding without running the tool."
      Condition="!Exists('$(_PoliCheckExe)') AND '$(LocalBuild)'=='true'" />

    <Exec
      Command="&quot;$(_PoliCheckExe)&quot; $(_PoliCheckArguments)"
      IgnoreExitCode="true"
      Condition="Exists('$(_PoliCheckExe)')" />
  </Target>

  <Target Name="_VerifyPolicheckResults">
    <RepoTasks.VerifyPoliCheckResults
      PoliCheckOutputFile="$(_PoliCheckOutputFile)"
      ExcludeTerms="$(Exclusions)"
      ExcludeFiles="@(FileExclusions)"
      DetailedExclusions="@(SrcExclusions)"
      Condition="Exists('$(_PoliCheckOutputFile)')" />
  </Target>
</Project>
